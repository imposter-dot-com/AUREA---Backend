# Sub-Publish Feature with Template-Specific HTML

## Overview

The **sub-publish** feature now generates **template-specific HTML files** that users can access via their custom subdomain. When a user publishes their portfolio, they get:

1. ✅ Custom subdomain (e.g., `aurea.tool/john-designer`)
2. ✅ Template-specific HTML (Echelon, Serene, etc.)
3. ✅ Standalone HTML files they can download/self-host
4. ✅ Case studies with uniform design

## How It Works

### User Flow

1. **User creates portfolio** with a template (Echelon or Serene)
2. **User clicks "Publish"** in the frontend
3. **User provides custom subdomain** (e.g., "john-designer")
4. **Backend generates HTML files**:
   - Main portfolio: Template-specific design (matches user's choice)
   - Case studies: Uniform design (consistent across all templates)
5. **Files saved to** `generated-files/{subdomain}/`
6. **User gets URL**: `aurea.tool/john-designer`

### Technical Flow

```
POST /api/sites/sub-publish
{
  "portfolioId": "...",
  "customSubdomain": "john-designer"
}

↓

1. Validate subdomain (format, availability)
2. Fetch portfolio + case studies
3. Generate template-specific HTML via template engine
4. Generate uniform case study pages
5. Save to generated-files/john-designer/
   ├── index.html (template-specific)
   ├── case-study-project1.html (uniform)
   └── case-study-project2.html (uniform)
6. Update database (Site + Portfolio models)
7. Return URLs and file paths
```

## API Endpoint

### POST `/api/sites/sub-publish`

**Request Body:**
```json
{
  "portfolioId": "68f3b7dc85b31aac1fb5ae1b",
  "customSubdomain": "john-designer"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Portfolio published successfully to local subdomain",
  "data": {
    "site": {
      "id": "...",
      "subdomain": "john-designer",
      "url": "aurea.tool/john-designer",
      "localUrl": "http://localhost:5000/api/sites/john-designer",
      "htmlFile": "/path/to/generated-files/john-designer/index.html",
      "published": true,
      "deploymentStatus": "success",
      "lastDeployedAt": "2025-10-18T18:50:00.000Z"
    },
    "portfolio": {
      "id": "68f3b7dc85b31aac1fb5ae1b",
      "title": "John's Portfolio",
      "slug": "john-designer",
      "template": "echolon",  // ← Shows which template was used
      "publishedUrl": "aurea.tool/john-designer"
    },
    "deployment": {
      "filesGenerated": [
        "index.html",
        "case-study-project1.html",
        "case-study-project2.html"
      ],
      "localPath": "/path/to/generated-files/john-designer",
      "template": "echolon",  // ← Confirms template used
      "validation": {
        "score": 95,
        "isValid": true
      }
    }
  }
}
```

## Subdomain Requirements

### Format Rules
- **Length**: 3-30 characters
- **Characters**: Lowercase letters, numbers, hyphens only
- **Pattern**: Must start/end with letter or number (not hyphen)
- **Examples**:
  - ✅ `john-designer`
  - ✅ `jane2024`
  - ✅ `creative-studio`
  - ❌ `ab` (too short)
  - ❌ `-john-` (starts/ends with hyphen)
  - ❌ `John_Designer` (uppercase and underscore)

### Validation
```javascript
const regex = /^[a-z0-9](?:[a-z0-9-]{1,28}[a-z0-9])?$/;
```

### Availability
- Subdomain must be **unique** across all users
- Users can update their **own** portfolio subdomain
- Users cannot take subdomains owned by other users
- System provides **suggestions** if subdomain is taken

## Generated Files

### File Structure
```
generated-files/
└── john-designer/              ← User's subdomain
    ├── index.html              ← Template-specific portfolio (Echelon/Serene)
    ├── case-study-project1.html  ← Uniform case study design
    └── case-study-project2.html  ← Uniform case study design
```

### index.html (Main Portfolio)
- **Design**: Template-specific (Echelon, Serene, etc.)
- **Generated by**: Template engine (fetches from frontend React components)
- **Features**:
  - Responsive HTML
  - Inline CSS (no external stylesheets)
  - Self-contained (can open directly in browser)
  - Real portfolio data embedded

### Case Study HTMLs
- **Design**: Uniform across all templates
- **Generated by**: `templateConvert.js`
- **Features**:
  - Consistent Swiss design
  - Professional case study layout
  - Linked from main portfolio

## Template Engine Integration

### How Templates are Selected

```javascript
// Priority order:
1. portfolio.templateId    // New field (preferred)
2. portfolio.template      // Legacy field
3. 'default'              // Fallback

// Example:
const template = portfolio.templateId || portfolio.template || 'default';
// → 'echolon' or 'serene'
```

### HTML Generation Process

```javascript
// 1. Generate template-specific portfolio HTML
const portfolioHTML = await getTemplateHTML(
  portfolioData,
  template,
  { forPDF: false }  // For web viewing, not PDF
);

// 2. Generate uniform case study pages
const allFiles = generateAllPortfolioFiles(portfolioData);

// 3. Combine files
const deploymentFiles = {
  'index.html': portfolioHTML,  // Template-specific
  ...Object.entries(allFiles)
    .filter(([key]) => key.startsWith('case-study-'))
    .reduce((obj, [k, v]) => ({ ...obj, [k]: v }), {})
};
```

### Fallback Strategy

If template engine fails (frontend not accessible):

1. **Primary**: Fetch HTML from frontend preview (template-specific)
2. **Fallback**: Use `templateConvert.js` (Swiss design)
3. **Error handling**: Always generates something

## Accessing Published Portfolios

### Two Ways to View Published Portfolios

When a user publishes their portfolio with subdomain `john-designer`, they get **two URLs**:

#### 1. **React Portfolio URL** (Interactive View)
```
Development: http://localhost:5173/portfolio/john-designer
Production:  https://aurea.tools/portfolio/john-designer
```

**Features:**
- ✅ Rendered using React components
- ✅ Interactive features and animations
- ✅ Full template functionality
- ✅ Best for sharing online

**How it works:**
- Frontend route: `/portfolio/:slug`
- Fetches JSON from: `GET /api/sites/:subdomain`
- Renders with React components

#### 2. **Static HTML URL** (Standalone File) - **Served from Frontend Domain**
```
Development: http://localhost:5173/john-designer/html
Production:  https://aurea.tools/john-designer/html
```

**Features:**
- ✅ Pure HTML file (no React wrapper)
- ✅ Served through frontend domain (aurea.tools)
- ✅ Same design as backend-generated HTML
- ✅ Case study navigation buttons included
- ✅ Links to case studies work: `https://aurea.tools/john-designer/case-study-{projectId}.html`

**How it works:**
1. Frontend catches route: `/:subdomain/html`
2. Frontend fetches HTML from backend: `GET /api/sites/:subdomain/raw-html`
3. Frontend replaces entire page with HTML content
4. Result: Looks like static HTML served from aurea.tools domain

**Routes:**
- Main portfolio: `GET /:subdomain/html` (frontend) → Fetches from backend API
- Case studies: `GET /:subdomain/case-study-:projectId.html` (frontend) → Fetches from backend API

### Backend Routes

#### Get Portfolio Data (JSON)
```bash
GET /api/sites/:subdomain
```
**Returns:**
```json
{
  "success": true,
  "data": {
    "title": "John's Portfolio",
    "content": {...},
    "templateId": "echolon",
    "caseStudies": [...],
    "site": {
      "subdomain": "john-designer",
      "url": "aurea.tool/john-designer",
      "published": true
    }
  }
}
```

#### Get Raw HTML Content (for Frontend)
```bash
# Main portfolio HTML
GET /api/sites/:subdomain/raw-html

# Case study HTML
GET /api/sites/:subdomain/case-study/:projectId/raw-html
```

**Returns:** JSON with HTML content
```json
{
  "success": true,
  "html": "<html>...</html>",
  "subdomain": "john-designer"
}
```

**File Locations:**
- Main portfolio: `generated-files/{subdomain}/index.html`
- Case studies: `generated-files/{subdomain}/case-study-{projectId}.html`

**Usage:** Frontend routes call these APIs to fetch HTML and display it

## Use Cases

### 1. Online Sharing (React View)
Share the React portfolio URL for interactive viewing:
```
https://aurea.tools/portfolio/john-designer
```
- Best for LinkedIn, Twitter, email signatures
- Full template features and animations

### 2. Self-Hosting (Static HTML)
Users can download the HTML files and host anywhere:
```bash
# Copy files
cp -r generated-files/john-designer /var/www/html/

# Works on any static host:
# - GitHub Pages
# - Netlify
# - Vercel
# - AWS S3
# - Their own server
```

### 3. Offline Portfolio
Users can open `index.html` directly in browser:
```bash
open generated-files/john-designer/index.html
```

### 4. Email/Share
Users can share the HTML file:
- Attach to emails
- Send to clients
- Include in applications
- Backup offline

## Subdomain Changes

### Updating Subdomain

When user changes subdomain from `john-designer` to `john-smith`:

```javascript
// Old behavior:
1. Generates new files in generated-files/john-smith/
2. Deletes old folder: generated-files/john-designer/
3. Updates database records
4. Returns new URLs

// Result:
Before: aurea.tool/john-designer (deleted)
After:  aurea.tool/john-smith (active)
```

## Frontend Integration

### Publish Button

```javascript
// In frontend
const publishPortfolio = async (portfolioId, subdomain) => {
  const response = await fetch('/api/sites/sub-publish', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      portfolioId,
      customSubdomain: subdomain
    })
  });

  const data = await response.json();

  if (data.success) {
    // Show success message
    console.log('Published at:', data.data.site.url);
    console.log('Template used:', data.data.portfolio.template);
    console.log('Files:', data.data.deployment.filesGenerated);
  }
};
```

### Subdomain Input

```jsx
<input
  type="text"
  placeholder="your-subdomain"
  pattern="[a-z0-9](?:[a-z0-9-]{1,28}[a-z0-9])?"
  minLength="3"
  maxLength="30"
  onChange={(e) => setSubdomain(e.target.value.toLowerCase())}
/>
```

### Preview Before Publish

```jsx
// Show user what URL they'll get
const previewUrl = `aurea.tool/${subdomain}`;

// Show template they're using
const template = portfolio.templateId || portfolio.template;
```

## Database Records

### Site Model
```javascript
{
  userId: ObjectId,
  portfolioId: ObjectId,
  subdomain: "john-designer",
  title: "John's Portfolio",
  template: "echolon",
  published: true,
  isActive: true,
  deploymentStatus: "success",
  lastDeployedAt: Date,
  files: ["index.html", "case-study-...html"],
  seo: {
    title: "John's Portfolio",
    description: "...",
    keywords: ["echolon", "John", "designer"]
  }
}
```

### Portfolio Model
```javascript
{
  _id: ObjectId,
  userId: ObjectId,
  title: "John's Portfolio",
  template: "echolon",  // or templateId
  slug: "john-designer",
  isPublished: true,
  publishedUrl: "aurea.tool/john-designer",
  publishedAt: Date
}
```

## Advantages

### For Users
1. **Custom URL**: Professional subdomain
2. **Template Fidelity**: HTML matches their template choice
3. **Portable**: Can download and host anywhere
4. **Offline Access**: Works without internet
5. **No Lock-in**: Not tied to platform

### For Platform
1. **Flexibility**: Users choose template
2. **Scalability**: Static files, no server rendering
3. **Speed**: Instant access (no build time)
4. **Cost**: Minimal hosting cost
5. **SEO**: Static HTML is crawlable

## Testing

### Test Publishing

```bash
curl -X POST http://localhost:5000/api/sites/sub-publish \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "portfolioId": "68f3b7dc85b31aac1fb5ae1b",
    "customSubdomain": "test-portfolio"
  }'
```

### Verify Files

```bash
ls generated-files/test-portfolio/
# Should show:
# index.html
# case-study-*.html (if any)

# Open in browser
open generated-files/test-portfolio/index.html
```

### Check Template

```bash
# Grep for template indicators in HTML
grep -i "echelon\|serene" generated-files/test-portfolio/index.html

# Check if styles match template
head -n 50 generated-files/test-portfolio/index.html
```

## Troubleshooting

### Subdomain Already Taken
**Error**: `409 Conflict`
**Solution**: Choose different subdomain or check suggestions in response

### Template Not Rendering
**Symptom**: HTML shows Swiss design instead of selected template
**Cause**: Template engine fallback activated
**Check**:
1. Frontend running? (`http://localhost:5173`)
2. Template exists in registry?
3. Check backend logs for template engine errors

### Missing Case Studies
**Symptom**: Case study links broken
**Cause**: Case studies not properly linked to projects
**Check**:
1. CaseStudy model has correct `projectId`
2. Portfolio projects have matching `id`
3. Check logs for case study generation

### Files Not Saved
**Symptom**: Folder empty or missing
**Cause**: Permission issues or path errors
**Check**:
1. `generated-files/` directory exists
2. Write permissions
3. Disk space

## Performance Optimizations

### Fast Generation Mode (Instant Publishing)

For web publishing, the system uses **fast generation mode** to avoid timeouts:

**Architecture Decision**:
- **Web Publishing (sub-publish)**: Uses `templateConvert.js` directly (instant, no Puppeteer)
- **PDF Export**: Uses template engine with Puppeteer (high fidelity)

**Benefits**:
- Publishing completes in **< 1 second** (no timeout issues)
- No browser startup overhead
- Instant file generation
- Same responsive HTML output

**Technical Implementation**:
```javascript
// In siteController.js subPublish()
const useFastGeneration = true; // Fast mode enabled

if (useFastGeneration) {
  // Generate all files instantly using templateConvert.js
  allFiles = generateAllPortfolioFiles(portfolioWithCaseStudies);
  portfolioHTML = allFiles['index.html'];
  // Result: < 1 second
}
```

### Timeout Configuration

**Frontend** (`portfolioApi.js`):
- Default API timeout: 15 seconds
- Publish endpoint: 30 seconds (allows for slower servers)

**Backend** (`siteController.js`):
- Fast generation: < 1 second
- Template engine fallback: 3-5 seconds (if enabled)

### Performance Comparison

| Method | Time | Use Case |
|--------|------|----------|
| Fast mode (templateConvert.js) | < 1s | **Web publishing (current)** |
| Template engine (Puppeteer) | 3-5s | PDF export |
| Template engine with retries | 10-15s | Avoided for web publishing |

### User Experience

**Publishing Flow**:
1. User clicks "Publish"
2. Progress indicator shows: "Validating subdomain..."
3. Progress updates to: "Generating HTML files..."
4. Complete in < 1 second
5. Success message with deployment details

**No More Timeouts**: Previous 10-second timeout issue resolved with fast generation mode.

## Future Enhancements

Potential improvements:

1. **Custom Domains**: `john.com` instead of `aurea.tool/john`
2. **Template Switching**: Change template without re-publishing
3. **Version History**: Keep old versions of published sites
4. **Analytics Dashboard**: Track views, visitors, etc.
5. **Custom CSS**: User-provided additional styles
6. **Markdown Support**: Edit content in markdown
7. **Automated Backups**: Scheduled backups to cloud storage
8. **Progressive Publishing**: Show real-time progress for large portfolios

---

**Last Updated**: October 2025
**Feature Status**: ✅ Active and Working
**Performance**: ⚡ Optimized for instant publishing (< 1 second)
